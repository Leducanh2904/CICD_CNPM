name: Simple Monitoring

on:
  schedule:
    - cron: "*/5 * * * *"     # má»—i 5 phÃºt
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      TARGET_URL: https://cicd-cnpm-1.onrender.com/api/health
      MAX_LATENCY_MS: "1500"

    steps:
      - name: Kiá»ƒm tra tÃ¬nh tráº¡ng website
        id: check
        shell: bash
        run: |
          echo "ðŸ” Checking $TARGET_URL..."
          OUT=$(curl -sS -o /dev/null -w "%{http_code} %{time_total}" "$TARGET_URL" || echo "000 99")
          CODE=${OUT%% *}
          SECS=${OUT##* }
          MS=$(awk -v s="$SECS" 'BEGIN{printf "%d\n", s*1000}')
          echo "HTTP code: $CODE | latency: ${MS}ms"

          echo "status=$CODE" >> "$GITHUB_OUTPUT"
          echo "latency_ms=$MS" >> "$GITHUB_OUTPUT"

          if [ "$CODE" != "200" ]; then
            echo "âŒ Website down (HTTP $CODE)"
            exit 1
          fi

          if [ "$MS" -gt "$MAX_LATENCY_MS" ]; then
            echo "âš ï¸ Latency too high (${MS}ms > ${MAX_LATENCY_MS}ms)"
            exit 1
          fi

          echo "âœ… Website OK"

