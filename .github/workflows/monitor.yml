name: Simple Monitoring

on:
  schedule:
    - cron: "*/5 * * * *"     # m·ªói 5 ph√∫t
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      TARGET_URL: https://cicd-cnpm-1.onrender.com/api/health
      MAX_LATENCY_MS: "1500"

    steps:
      - name: Ki·ªÉm tra t√¨nh tr·∫°ng website
        id: check
        shell: bash
        run: |
          echo "üîç Checking $TARGET_URL..."
          OUT=$(curl -sS -o /dev/null -w "%{http_code} %{time_total}" "$TARGET_URL" || echo "000 99")
          CODE=${OUT%% *}
          SECS=${OUT##* }
          MS=$(awk -v s="$SECS" 'BEGIN{printf "%d\n", s*1000}')
          echo "HTTP code: $CODE | latency: ${MS}ms"

          echo "status=$CODE" >> "$GITHUB_OUTPUT"
          echo "latency_ms=$MS" >> "$GITHUB_OUTPUT"

          if [ "$CODE" != "200" ]; then
            echo "‚ùå Website down (HTTP $CODE)"
            exit 1
          fi

          if [ "$MS" -gt "$MAX_LATENCY_MS" ]; then
            echo "‚ö†Ô∏è Latency too high (${MS}ms > ${MAX_LATENCY_MS}ms)"
            exit 1
          fi

          echo "‚úÖ Website OK"

      - name: Ghi log ra GitHub Issues (t√πy ch·ªçn)
        if: failure() && github.event_name != 'pull_request'
        uses: dacbd/create-issue-action@v1
        with:
          token: ${{ github.token }}
          title: "‚ö†Ô∏è Health check FAILED"
          body: |
            URL: ${{ env.TARGET_URL }}
            Status: ${{ steps.check.outputs.status }}
            Latency: ${{ steps.check.outputs.latency_ms }}ms
            Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
