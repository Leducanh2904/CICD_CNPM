name: Simple Monitoring

on:
  schedule:
    - cron: "*/5 * * * *" # ch·∫°y m·ªói 10 ph√∫t
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      TARGET_URL: https://cicd-cnpm-1.onrender.com/api/health   # <-- ƒë·ªïi th√†nh URL th·∫≠t c·ªßa b·∫°n
      MAX_LATENCY_MS: "1500"
    steps:
      - name: Ki·ªÉm tra t√¨nh tr·∫°ng website
        id: check
        run: |
          echo "üîç Checking $TARGET_URL..."
          OUT=$(curl -sS -o /dev/null -w "%{http_code} %{time_total}" "$TARGET_URL" || echo "000 99")
          CODE=$(echo "$OUT" | awk '{print $1}')
          SECS=$(echo "$OUT" | awk '{print $2}')
          MS=$(python - <<PYsec="$SECS"print(int(float(sec)*1000))PY)
          echo "HTTP code: $CODE | latency: ${MS}ms"
          echo "status=$CODE" >> $GITHUB_OUTPUT
          echo "latency_ms=$MS" >> $GITHUB_OUTPUT

          if [ "$CODE" != "200" ]; then
            echo "‚ùå Website down (HTTP $CODE)"
            exit 1
          fi

          if [ "$MS" -gt "$MAX_LATENCY_MS" ]; then
            echo "‚ö†Ô∏è Latency too high (${MS}ms > ${MAX_LATENCY_MS}ms)"
            exit 1
          fi

          echo "‚úÖ Website healthy"

      - name: Ghi log ra GitHub Issues (t√πy ch·ªçn)
        if: failure()
        uses: dacbd/create-issue-action@v1
        with:
          token: ${{ github.token }}
          title: "‚ö†Ô∏è Health check FAILED"
          body: |
            URL: ${{ env.TARGET_URL }}
            Status: ${{ steps.check.outputs.status }}
            Latency: ${{ steps.check.outputs.latency_ms }}ms
            Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
